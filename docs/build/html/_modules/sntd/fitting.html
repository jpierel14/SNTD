

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sntd.fitting &mdash; SNTD 1.0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> SNTD
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Simulating with SNTD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html#measuring-time-delays-with-sntd">Measuring Time Delays with SNTD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API Documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SNTD</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sntd.fitting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sntd.fitting</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">inspect</span><span class="o">,</span><span class="nn">sncosmo</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">warnings</span><span class="o">,</span><span class="nn">pyParz</span><span class="o">,</span><span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span><span class="p">,</span><span class="n">copy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="k">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">astropy.extern</span> <span class="k">import</span> <span class="n">six</span>
<span class="kn">import</span> <span class="nn">nestle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="k">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="k">import</span> <span class="n">RBF</span>
<span class="kn">import</span> <span class="nn">scipy</span>

<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.curve_io</span> <span class="k">import</span> <span class="n">_sntd_deepcopy</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.ml</span> <span class="k">import</span> <span class="o">*</span>

<span class="n">__all__</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fit_data&#39;</span><span class="p">]</span>

<span class="n">__thetaSN__</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;hostebv&#39;</span><span class="p">,</span><span class="s1">&#39;screenebv&#39;</span><span class="p">,</span><span class="s1">&#39;screenz&#39;</span><span class="p">,</span><span class="s1">&#39;rise&#39;</span><span class="p">,</span><span class="s1">&#39;fall&#39;</span><span class="p">,</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
<span class="n">__thetaL__</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">,</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span><span class="s1">&#39;dt0&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span><span class="s1">&#39;psi&#39;</span><span class="p">,</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;microlensingA&#39;</span><span class="p">,</span><span class="s1">&#39;microlensingD&#39;</span><span class="p">]</span>


<span class="n">_needs_bounds</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;z&#39;</span><span class="p">}</span>

<span class="k">class</span> <span class="nc">newDict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is just a dictionary replacement class that allows the use of a normal dictionary but with the ability</span>
<span class="sd">    to access via &quot;dot&quot; notation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">newDict</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="c1"># these three functions allow you to access the curveDict via &quot;dot&quot; notation</span>
    <span class="fm">__setattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__setitem__</span>
    <span class="fm">__delattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__delitem__</span>
    <span class="fm">__getattr__</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function necessary for pickling</span>
<span class="sd">        :return: self</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A function necessary for pickling</span>
<span class="sd">        :param d: A value</span>
<span class="sd">        :return: self.__dict__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">d</span>



<div class="viewcode-block" id="fit_data"><a class="viewcode-back" href="../../api.html#sntd.fitting.fit_data">[docs]</a><span class="k">def</span> <span class="nf">fit_data</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">snType</span><span class="o">=</span><span class="s1">&#39;Ia&#39;</span><span class="p">,</span><span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">models</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">{},</span> <span class="n">ignore</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constants</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">method</span><span class="o">=</span><span class="s1">&#39;separate&#39;</span><span class="p">,</span><span class="n">t0_guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">effect_names</span><span class="o">=</span><span class="p">[],</span><span class="n">effect_frames</span><span class="o">=</span><span class="p">[],</span><span class="n">fitting_method</span><span class="o">=</span><span class="s1">&#39;nest&#39;</span><span class="p">,</span>
             <span class="n">dust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">guess_amplitude</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">combinedError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">showPlots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">microlensing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;RBF&#39;</span><span class="p">,</span><span class="n">combinedGrids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">refImage</span><span class="o">=</span><span class="s1">&#39;image_1&#39;</span><span class="p">,</span><span class="n">nMicroSamples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main high-level fitting function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    curves: :class:`sntd.curve_io.curveDict`</span>
<span class="sd">        The curveDict object containing the multiple images to fit.</span>
<span class="sd">    snType: str</span>
<span class="sd">        The supernova classification</span>
<span class="sd">    bands: list of :class:`~sncosmo.bandpasses.Bandpass` or str</span>
<span class="sd">        The band(s) to be fit</span>
<span class="sd">    models: list</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curves&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands</span><span class="p">]</span> <span class="k">if</span> <span class="n">bands</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bands</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">bands</span>
    <span class="c1">#sets the bands to user&#39;s if defined (set, so that they&#39;re unique), otherwise to all the bands that exist in curves</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bands</span><span class="p">))</span> <span class="k">if</span> <span class="n">bands</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">bands</span><span class="p">)</span>

    <span class="n">models</span><span class="o">=</span><span class="p">[</span><span class="n">models</span><span class="p">]</span> <span class="k">if</span> <span class="n">models</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">models</span><span class="p">,(</span><span class="nb">tuple</span><span class="p">,</span><span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="n">models</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">models</span><span class="p">:</span>
        <span class="n">mod</span><span class="p">,</span><span class="n">types</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="fm">__dir__</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">,</span><span class="s1">&#39;sncosmo&#39;</span><span class="p">,</span><span class="s1">&#39;models.ref&#39;</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span><span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">modDict</span><span class="o">=</span><span class="p">{</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mod</span><span class="p">))}</span>
        <span class="k">if</span> <span class="n">snType</span><span class="o">!=</span><span class="s1">&#39;Ia&#39;</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">_SOURCES</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">modDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">modDict</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]][:</span><span class="nb">len</span><span class="p">(</span><span class="n">snType</span><span class="p">)]</span><span class="o">==</span><span class="n">snType</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">snType</span><span class="o">==</span><span class="s1">&#39;Ia&#39;</span><span class="p">:</span>
            <span class="n">mods</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">_SOURCES</span><span class="o">.</span><span class="n">_loaders</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;salt2&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mods</span><span class="o">=</span><span class="n">models</span>
    <span class="n">mods</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sn_func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;minuit&#39;</span><span class="p">:</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">fit_lc</span><span class="p">,</span> <span class="s1">&#39;mcmc&#39;</span><span class="p">:</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">mcmc_lc</span><span class="p">,</span> <span class="s1">&#39;nest&#39;</span><span class="p">:</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">}</span>
    <span class="c1">#get any properties set in kwargs that exist for the defined fitting function</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span>
                     <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;sn_func&#39;</span><span class="p">][</span><span class="n">fitting_method</span><span class="p">])[</span><span class="mi">0</span><span class="p">]]</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;verbose&#39;</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;separate&#39;</span><span class="p">,</span><span class="s1">&#39;combined&#39;</span><span class="p">,</span><span class="s1">&#39;color&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Parameter &quot;method&quot; must be &quot;separate&quot;,&quot;combined&quot;, or &quot;color&quot;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;separate&#39;</span><span class="p">:</span>
        <span class="n">curves</span><span class="o">=</span><span class="n">_fitSeparate</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curves&#39;</span><span class="p">],</span><span class="n">mods</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;combined&#39;</span><span class="p">:</span>

        <span class="n">curves</span><span class="o">=</span><span class="n">_fitCombined</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curves&#39;</span><span class="p">],</span><span class="n">mods</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">combinedGrids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curves</span><span class="o">=</span><span class="n">_fitColor</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curves&#39;</span><span class="p">],</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">combinedGrids</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">curves</span></div>

<span class="k">def</span> <span class="nf">_fitColor</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">grids</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">minsnr</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
              <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxcall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelcov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">])</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If you want to analyze color curves, you need two bands!&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">curves</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">combine_curves</span><span class="p">(</span><span class="n">referenceImage</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">])</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">grids</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Need bounds on time delay and magnification (i.e. combinedGrids undefined)&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;image_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">create_composite_model</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;logz&#39;</span><span class="p">,</span><span class="n">bound_vars</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">create_composite_model</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">bound_vars</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Combined fit had no reference model or model name.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Your reference model needs to be an SNCosmo model object.&quot;</span><span class="p">)</span>


    <span class="n">gridBounds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">==</span><span class="s1">&#39;td&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">==</span><span class="s1">&#39;mu&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">gridBounds</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="n">par</span><span class="p">])</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">time_delays</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">magnifications</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">time_delay_errors</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">magnification_errors</span><span class="p">,</span><span class="n">bestRes</span><span class="p">,</span><span class="n">bestMod</span><span class="o">=</span> \
        <span class="n">nest_color_lc</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">],</span>
                      <span class="n">vparam_names</span><span class="o">=</span><span class="n">gridBounds</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">bands</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">],</span>
                      <span class="n">refModel</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">gridBounds</span><span class="p">,</span><span class="n">snBounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                      <span class="n">snVparam_names</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">ref</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="c1">#fix this whole color curve thing, the problem is that right now I&#39;m just dividing one column by the other, but</span>
    <span class="c1">#I need to separate it out by image first or else it&#39;ll get all mixed up...</span>
    <span class="n">temp</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">])</span>
    <span class="n">temp</span><span class="o">.</span><span class="n">color_table</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">time_delays</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">time_delays</span><span class="p">,</span><span class="n">magnifications</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">magnifications</span><span class="p">)</span>


    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bestMod</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bestRes</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">nest_color_lc</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">snBounds</span><span class="p">,</span><span class="n">snVparam_names</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">bands</span><span class="o">=</span><span class="p">[],</span>
                  <span class="n">minsnr</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span><span class="n">refModel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                  <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxcall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelcov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># experimental parameters</span>
    <span class="n">tied</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">vparam_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ppfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ppfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">tied</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tied</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Convert bounds/priors combinations into ppfs</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ppfs take priority over bounds/priors</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
                <span class="c1"># solve ppf at discrete points and return interpolating</span>
                <span class="c1"># function</span>
                <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
                <span class="n">ppf_samples</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">x_samples</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">ppf_samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span>
            <span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

    <span class="c1"># NOTE: It is important that iparam_names is in the same order</span>
    <span class="c1"># every time, otherwise results will not be reproducible, even</span>
    <span class="c1"># with same random seed.  This is because iparam_names[i] is</span>
    <span class="c1"># matched to u[i] below and u will be in a reproducible order,</span>
    <span class="c1"># so iparam_names must also be.</span>

    <span class="n">all_delays</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mus</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mu_err</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_delay_err</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mu_err</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_delay_err</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_delays</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_mus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">iparam_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vparam_names</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">]</span>

    <span class="n">ppflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">]</span>
    <span class="n">npdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iparam_names</span><span class="p">)</span>  <span class="c1"># length of u</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">)</span>  <span class="c1"># length of v</span>

    <span class="c1"># Check that all param_names either have a direct prior or are tied.</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tied</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply ppf or bounds or tied for parameter &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">prior_transform</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npdim</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ppflist</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">vparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tied</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>


    <span class="k">global</span> <span class="n">best_comb_Z</span>
    <span class="k">global</span> <span class="n">best_comb_Mod</span>
    <span class="k">global</span> <span class="n">best_comb_Res</span>

    <span class="n">best_comb_Res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_comb_Mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_comb_Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">def</span> <span class="nf">chisquare</span><span class="p">(</span><span class="n">observed_values</span><span class="p">,</span><span class="n">expected_values</span><span class="p">,</span><span class="n">errors</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_values</span> <span class="o">-</span> <span class="n">expected_values</span><span class="p">)</span> <span class="o">/</span> <span class="n">errors</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">z</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi2</span>


    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="n">tempCurve</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>


        <span class="n">tempTds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="n">tempMus</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;td&#39;</span><span class="p">:</span>
                <span class="n">tempTds</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]]</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span>
                <span class="n">tempMus</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]]</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tempTds</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="n">all_delays</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
        <span class="n">tempMus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="n">all_mus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
        <span class="n">tempCurve</span><span class="o">.</span><span class="n">color_table</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">time_delays</span><span class="o">=</span><span class="n">tempTds</span><span class="p">,</span><span class="n">magnifications</span><span class="o">=</span><span class="n">tempMus</span><span class="p">)</span>
        <span class="n">tempCurve</span><span class="o">.</span><span class="n">combine_curves</span><span class="p">(</span><span class="n">time_delays</span><span class="o">=</span><span class="n">tempTds</span><span class="p">,</span><span class="n">magnifications</span><span class="o">=</span><span class="n">tempMus</span><span class="p">,</span><span class="n">referenceImage</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">zpDict</span><span class="o">=</span><span class="p">{</span><span class="n">b</span><span class="p">:</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;zp&#39;</span><span class="p">][</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">}</span>
        <span class="n">zpsys</span><span class="o">=</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;zpsys&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tempRes</span><span class="p">,</span><span class="n">tempMod</span><span class="o">=</span><span class="n">_inner_color_nest_lc</span><span class="p">(</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="p">,</span><span class="n">refModel</span><span class="p">,</span><span class="n">bands</span><span class="p">,</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">snVparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">snBounds</span><span class="p">,</span>
                                             <span class="n">zp</span><span class="o">=</span><span class="n">zpDict</span><span class="p">,</span><span class="n">zpsys</span><span class="o">=</span><span class="n">zpsys</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="k">global</span> <span class="n">best_comb_Res</span>
        <span class="k">global</span> <span class="n">best_comb_Mod</span>
        <span class="k">global</span> <span class="n">best_comb_Z</span>
        <span class="k">if</span> <span class="n">tempRes</span><span class="o">.</span><span class="n">logz</span><span class="o">&gt;</span><span class="n">best_comb_Z</span><span class="p">:</span>
            <span class="n">best_comb_Res</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempRes</span><span class="p">)</span>
            <span class="n">best_comb_Z</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempRes</span><span class="o">.</span><span class="n">logz</span><span class="p">)</span>
            <span class="n">best_comb_Mod</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempMod</span><span class="p">)</span>

        <span class="c1">#for im in tempCurve.images.keys():</span>
        <span class="c1">#    tempCurve.color.table[&#39;time&#39;][tempCurve.color.table[&#39;image&#39;]==im]-=tempTds[im]</span>
        <span class="c1">#    tempCurve.color.table[bands[0]+&#39;-&#39;+bands[1]][tempCurve.color.table[&#39;image&#39;]==im]+=2.5*np.log10(tempMus[im])</span>

        <span class="n">tempColor</span><span class="o">=</span><span class="n">tempMod</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;ab&#39;</span><span class="p">,</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tempColor</span><span class="p">)]</span>
        <span class="n">tempColor</span><span class="o">=</span><span class="n">tempColor</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tempColor</span><span class="p">)]</span>


        <span class="n">chisq</span><span class="o">=-</span><span class="n">chisquare</span><span class="p">(</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                         <span class="n">tempColor</span><span class="p">,</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">color</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">tempColor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chisq</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;woah&#39;</span><span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">chisq</span><span class="p">)</span>




    <span class="n">res</span> <span class="o">=</span> <span class="n">nestle</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loglike</span><span class="p">,</span> <span class="n">prior_transform</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">npdim</span><span class="o">=</span><span class="n">npdim</span><span class="p">,</span>
                        <span class="n">npoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                        <span class="n">maxcall</span><span class="o">=</span><span class="n">maxcall</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="n">rstate</span><span class="p">,</span>
                        <span class="n">callback</span><span class="o">=</span><span class="p">(</span><span class="n">nestle</span><span class="o">.</span><span class="n">print_progress</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span>
                               <span class="n">ncall</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">ncall</span><span class="p">,</span>
                               <span class="n">logz</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logz</span><span class="p">,</span>
                               <span class="n">logzerr</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logzerr</span><span class="p">,</span>
                               <span class="n">h</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
                               <span class="n">samples</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                               <span class="n">logvol</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logvol</span><span class="p">,</span>
                               <span class="n">logl</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logl</span><span class="p">,</span>
                               <span class="n">vparam_names</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">),</span>
                               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">=</span><span class="n">_get_marginal_pdfs</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="n">ref</span><span class="p">]:</span>
        <span class="n">all_delays</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_td&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">all_delay_err</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_td&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">all_mus</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_mu&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">all_mu_err</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_mu&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">all_delays</span><span class="p">,</span><span class="n">all_mus</span><span class="p">,</span><span class="n">all_delay_err</span><span class="p">,</span><span class="n">all_mu_err</span><span class="p">,</span><span class="n">best_comb_Res</span><span class="p">,</span><span class="n">best_comb_Mod</span>

<span class="k">def</span> <span class="nf">_inner_color_nest_lc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span><span class="n">vparam_names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span><span class="n">zp</span><span class="p">,</span> <span class="n">zpsys</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">minsnr</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                         <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxcall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelcov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>


    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">nestle</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s2">&quot;nest_lc() requires the nestle package.&quot;</span><span class="p">)</span>

    <span class="c1"># warnings</span>
    <span class="k">if</span> <span class="s2">&quot;nobj&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The nobj keyword is deprecated and will be removed in &quot;</span>
                      <span class="s2">&quot;sncosmo v2.0. Use `npoints` instead.&quot;</span><span class="p">)</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nobj&quot;</span><span class="p">)</span>

    <span class="c1"># experimental parameters</span>
    <span class="n">tied</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


    <span class="n">sortidx</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>  <span class="c1"># need to copy this b/c we modify it below</span>

    <span class="c1"># Order vparam_names the same way it is ordered in the model:</span>
    <span class="n">vparam_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">]</span>



    <span class="k">if</span> <span class="n">guess_amplitude_bound</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amplitude bounds guessing enabled but &quot;</span>
                             <span class="s2">&quot;amplitude parameter </span><span class="si">{0!r}</span><span class="s2"> is not varied&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot supply bounds for parameter </span><span class="si">{0!r}</span><span class="s2">&quot;</span>
                             <span class="s2">&quot; when guess_amplitude_bound=True&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

            <span class="c1"># If redshift is bounded, set model redshift to midpoint of bounds</span>
            <span class="c1"># when doing the guess.</span>


    <span class="k">if</span> <span class="n">ppfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ppfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">tied</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tied</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Convert bounds/priors combinations into ppfs</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ppfs take priority over bounds/priors</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
                <span class="c1"># solve ppf at discrete points and return interpolating</span>
                <span class="c1"># function</span>
                <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
                <span class="n">ppf_samples</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">x_samples</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">ppf_samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span>
            <span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

    <span class="c1"># NOTE: It is important that iparam_names is in the same order</span>
    <span class="c1"># every time, otherwise results will not be reproducible, even</span>
    <span class="c1"># with same random seed.  This is because iparam_names[i] is</span>
    <span class="c1"># matched to u[i] below and u will be in a reproducible order,</span>
    <span class="c1"># so iparam_names must also be.</span>
    <span class="n">iparam_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vparam_names</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">]</span>
    <span class="n">ppflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">]</span>
    <span class="n">npdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iparam_names</span><span class="p">)</span>  <span class="c1"># length of u</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">)</span>  <span class="c1"># length of v</span>

    <span class="c1"># Check that all param_names either have a direct prior or are tied.</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tied</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply ppf or bounds or tied for parameter &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">prior_transform</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npdim</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ppflist</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">vparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tied</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="c1"># Indicies of the model parameters in vparam_names</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span><span class="n">zp</span><span class="p">,</span><span class="n">zpsys</span><span class="p">):</span>
        <span class="n">mCol</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">zpsys</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
        <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mCol</span><span class="p">)]</span>
        <span class="n">mCol</span><span class="o">=</span><span class="n">mCol</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mCol</span><span class="p">)]</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span> <span class="n">mCol</span>
        <span class="n">chi</span><span class="o">=</span><span class="n">diff</span><span class="o">/</span><span class="n">data</span><span class="p">[</span><span class="n">bands</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">bands</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_err&#39;</span><span class="p">]</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chi2</span>

    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>

        <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span>

        <span class="n">chisq_res</span><span class="o">=</span><span class="n">chisq</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">zp</span><span class="p">,</span><span class="n">zpsys</span><span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chisq_res</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">nestle</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loglike</span><span class="p">,</span> <span class="n">prior_transform</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">npdim</span><span class="o">=</span><span class="n">npdim</span><span class="p">,</span>
                        <span class="n">npoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                        <span class="n">maxcall</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="n">rstate</span><span class="p">,</span>
                        <span class="n">callback</span><span class="o">=</span><span class="p">(</span><span class="n">nestle</span><span class="o">.</span><span class="n">print_progress</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

    <span class="c1"># estimate parameters and covariance from samples</span>
    <span class="n">vparameters</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">nestle</span><span class="o">.</span><span class="n">mean_and_cov</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># update model parameters to estimated ones.</span>
    <span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">,</span> <span class="n">vparameters</span><span class="p">)))</span>


    <span class="c1"># `res` is a nestle.Result object. Collect result into a sncosmo.Result</span>
    <span class="c1"># object for consistency, and add more fields.</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span>
                               <span class="n">ncall</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">ncall</span><span class="p">,</span>
                               <span class="n">logz</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logz</span><span class="p">,</span>
                               <span class="n">logzerr</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logzerr</span><span class="p">,</span>
                               <span class="n">h</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
                               <span class="n">samples</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                               <span class="n">logvol</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logvol</span><span class="p">,</span>
                               <span class="n">logl</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logl</span><span class="p">,</span>
                               <span class="n">vparam_names</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">),</span>
                               <span class="n">ndof</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">),</span>
                               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                               <span class="n">parameters</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                               <span class="n">covariance</span><span class="o">=</span><span class="n">cov</span><span class="p">,</span>
                               <span class="n">errors</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">,</span>
                                                      <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">cov</span><span class="p">)))),</span>
                               <span class="n">param_dict</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span>
                                                          <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">_fitCombined</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">mods</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">grids</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">minsnr</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                 <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxcall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelcov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">curves</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">combine_curves</span><span class="p">(</span><span class="n">referenceImage</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">])</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">grids</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Need bounds on time delay and magnification (i.e. combinedGrids undefined)&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="s1">&#39;image_1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">create_composite_model</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;logz&#39;</span><span class="p">,</span><span class="n">bound_vars</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">create_composite_model</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">bound_vars</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Combined fit had no reference model or model name.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Your reference model needs to be an SNCosmo model object.&quot;</span><span class="p">)</span>

    <span class="n">gridBounds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">grids</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">==</span><span class="s1">&#39;td&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">par</span><span class="o">==</span><span class="s1">&#39;mu&#39;</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">gridBounds</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grids</span><span class="p">[</span><span class="n">par</span><span class="p">])</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="n">par</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

    <span class="n">myRes</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]:</span>
        <span class="n">myRes</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">nest_combined_lc</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">],</span>
                                  <span class="n">vparam_names</span><span class="o">=</span><span class="n">gridBounds</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span>
                                  <span class="n">band</span><span class="o">=</span><span class="n">b</span><span class="p">,</span><span class="n">refModel</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refModel&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">gridBounds</span><span class="p">,</span><span class="n">snBounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                  <span class="n">snVparam_names</span><span class="o">=</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">ref</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">],</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">myRes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">logz</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]])</span>
    <span class="n">final_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">myRes</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
        <span class="n">final_params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">myRes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]],</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">time_delays</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">magnifications</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">magnification_errors</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">time_delay_errors</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">time_delays</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">myRes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]],</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">magnifications</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">myRes</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]],</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">time_delay_errors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">myRes</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">magnification_errors</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">myRes</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bestRes</span><span class="o">=</span><span class="n">myRes</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">bestMod</span><span class="o">=</span><span class="n">myRes</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]][</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">bestMod</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">final_params</span><span class="p">)</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combine_curves</span><span class="p">(</span><span class="n">time_delays</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">time_delays</span><span class="p">,</span><span class="n">magnifications</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">magnifications</span><span class="p">,</span><span class="n">referenceImage</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;refImage&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>

    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bestMod</span>
    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">bestRes</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">create_composite_model</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">weight</span><span class="o">=</span><span class="s1">&#39;chisq&#39;</span><span class="p">,</span><span class="n">bound_vars</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="n">weight</span><span class="p">]</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()))])</span>
    <span class="k">if</span> <span class="n">weight</span><span class="o">==</span><span class="s1">&#39;chisq&#39;</span><span class="p">:</span>
        <span class="n">weights</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="n">weights</span>
    <span class="n">final_vars</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">bounds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound_vars</span><span class="p">:</span>
            <span class="n">final_vars</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_vars</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()))],</span>
                                         <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">bound_vars</span><span class="p">:</span>
            <span class="n">bounds</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">final_errs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()))],</span>
                                     <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>
            <span class="n">bounds</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">final_vars</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">-</span><span class="n">bounds</span><span class="p">[</span><span class="n">param</span><span class="p">],</span><span class="n">final_vars</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">+</span><span class="n">bounds</span><span class="p">[</span><span class="n">param</span><span class="p">])</span>

            <span class="n">final_mod</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">weights</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
    <span class="n">final_mod</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">final_vars</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">final_mod</span><span class="p">,</span><span class="n">bounds</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">nest_combined_lc</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">snBounds</span><span class="p">,</span><span class="n">snVparam_names</span><span class="p">,</span><span class="n">ref</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">minsnr</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span><span class="n">refModel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ppfs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span><span class="p">,</span>
                     <span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxcall</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">modelcov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="c1"># experimental parameters</span>
    <span class="n">tied</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tied&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">vparam_names</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ppfs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ppfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">tied</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tied</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Convert bounds/priors combinations into ppfs</span>
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">bounds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># ppfs take priority over bounds/priors</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">priors</span><span class="p">:</span>
                <span class="c1"># solve ppf at discrete points and return interpolating</span>
                <span class="c1"># function</span>
                <span class="n">x_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
                <span class="n">ppf_samples</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">priors</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">x_samples</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">ppf_samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Interp1D</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]))</span>
            <span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

    <span class="c1"># NOTE: It is important that iparam_names is in the same order</span>
    <span class="c1"># every time, otherwise results will not be reproducible, even</span>
    <span class="c1"># with same random seed.  This is because iparam_names[i] is</span>
    <span class="c1"># matched to u[i] below and u will be in a reproducible order,</span>
    <span class="c1"># so iparam_names must also be.</span>

    <span class="n">all_delays</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mus</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mu_err</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_delay_err</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">all_mu_err</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_delay_err</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_delays</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">all_mus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">iparam_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vparam_names</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ppfs</span><span class="p">]</span>

    <span class="n">ppflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ppfs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">]</span>
    <span class="n">npdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iparam_names</span><span class="p">)</span>  <span class="c1"># length of u</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">)</span>  <span class="c1"># length of v</span>

    <span class="c1"># Check that all param_names either have a direct prior or are tied.</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">vparam_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">iparam_names</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tied</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must supply ppf or bounds or tied for parameter &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">prior_transform</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npdim</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ppflist</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">vparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tied</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>


    <span class="k">global</span> <span class="n">best_comb_Z</span>
    <span class="k">global</span> <span class="n">best_comb_Mod</span>
    <span class="k">global</span> <span class="n">best_comb_Res</span>

    <span class="n">best_comb_Res</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_comb_Mod</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_comb_Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>


    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
        <span class="n">tempCurve</span><span class="o">=</span><span class="n">_sntd_deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>

        <span class="n">tempTds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="n">tempMus</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;td&#39;</span><span class="p">:</span>
                <span class="n">tempTds</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]]</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;mu&#39;</span><span class="p">:</span>
                <span class="n">tempMus</span><span class="p">[</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">iparam_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]]</span><span class="o">=</span><span class="n">parameters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">tempTds</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="n">all_delays</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>
        <span class="n">tempMus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">=</span><span class="n">all_mus</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span>

        <span class="n">tempCurve</span><span class="o">.</span><span class="n">combine_curves</span><span class="p">(</span><span class="n">time_delays</span><span class="o">=</span><span class="n">tempTds</span><span class="p">,</span><span class="n">magnifications</span><span class="o">=</span><span class="n">tempMus</span><span class="p">,</span><span class="n">referenceImage</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>

        <span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">band</span><span class="p">]</span>
        <span class="n">tempRes</span><span class="p">,</span><span class="n">tempMod</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">tempCurve</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">table</span><span class="p">,</span><span class="n">refModel</span><span class="p">,</span>
                                        <span class="n">vparam_names</span><span class="o">=</span><span class="n">snVparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">snBounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">best_comb_Res</span>
        <span class="k">global</span> <span class="n">best_comb_Mod</span>
        <span class="k">global</span> <span class="n">best_comb_Z</span>
        <span class="k">if</span> <span class="n">tempRes</span><span class="o">.</span><span class="n">logz</span><span class="o">&gt;</span><span class="n">best_comb_Z</span><span class="p">:</span>
            <span class="n">best_comb_Res</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempRes</span><span class="p">)</span>
            <span class="n">best_comb_Z</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempRes</span><span class="o">.</span><span class="n">logz</span><span class="p">)</span>
            <span class="n">best_comb_Mod</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">tempMod</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">tempRes</span><span class="o">.</span><span class="n">logz</span><span class="p">)</span>




    <span class="n">res</span> <span class="o">=</span> <span class="n">nestle</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">loglike</span><span class="p">,</span> <span class="n">prior_transform</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">npdim</span><span class="o">=</span><span class="n">npdim</span><span class="p">,</span>
                        <span class="n">npoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                        <span class="n">maxcall</span><span class="o">=</span><span class="n">maxcall</span><span class="p">,</span> <span class="n">rstate</span><span class="o">=</span><span class="n">rstate</span><span class="p">,</span>
                        <span class="n">callback</span><span class="o">=</span><span class="p">(</span><span class="n">nestle</span><span class="o">.</span><span class="n">print_progress</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span><span class="p">))</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Result</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">niter</span><span class="p">,</span>
                               <span class="n">ncall</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">ncall</span><span class="p">,</span>
                               <span class="n">logz</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logz</span><span class="p">,</span>
                               <span class="n">logzerr</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logzerr</span><span class="p">,</span>
                               <span class="n">h</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">h</span><span class="p">,</span>
                               <span class="n">samples</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
                               <span class="n">weights</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span>
                               <span class="n">logvol</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logvol</span><span class="p">,</span>
                               <span class="n">logl</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">logl</span><span class="p">,</span>
                               <span class="n">vparam_names</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">vparam_names</span><span class="p">),</span>
                               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    <span class="n">pdf</span><span class="o">=</span><span class="n">_get_marginal_pdfs</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="n">npoints</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="n">ref</span><span class="p">]:</span>
        <span class="n">all_delays</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_td&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">all_delay_err</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_td&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">all_mus</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_mu&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">all_mu_err</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">pdf</span><span class="p">[</span><span class="n">im</span><span class="o">+</span><span class="s1">&#39;_mu&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">all_delays</span><span class="p">,</span><span class="n">all_mus</span><span class="p">,</span><span class="n">all_delay_err</span><span class="p">,</span><span class="n">all_mu_err</span><span class="p">,</span><span class="n">best_comb_Res</span><span class="p">,</span><span class="n">best_comb_Mod</span>




<span class="k">def</span> <span class="nf">_fitSeparate</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">mods</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">bounds</span><span class="p">):</span>
    <span class="n">resList</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">fitDict</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">if</span> <span class="s1">&#39;t0&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
        <span class="n">t0Bounds</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;t0&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
        <span class="n">ampBounds</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amplitude&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#print(curves.images[d].simMeta)</span>
        <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;t0&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">],</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxFlux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>
                <span class="n">maxTime</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">maxFlux</span><span class="p">]</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">maxTime</span><span class="p">,</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maxTime</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;guess_amp&#39;</span><span class="p">]:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ampBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]),</span><span class="n">ampBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]))</span>



        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="kc">True</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">63</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;snType&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Ia&#39;</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="n">mods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mod</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;BazinSource&#39;</span><span class="p">,</span><span class="s1">&#39;KarpenkaSource&#39;</span><span class="p">,</span><span class="s1">&#39;NewlingSource&#39;</span><span class="p">,</span><span class="s1">&#39;PierelSource&#39;</span><span class="p">]:</span>
                    <span class="n">fits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_fit</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">mod</span><span class="p">))</span>


                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mods</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">doFit</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">doFit</span><span class="o">=</span><span class="kc">True</span>
                    <span class="n">args</span><span class="p">[</span><span class="s1">&#39;doFit&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">doFit</span>
                    <span class="n">fits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_fit_data_wrap</span><span class="p">((</span><span class="n">mod</span><span class="p">,</span><span class="n">args</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;doFit&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
            <span class="n">fits</span><span class="o">=</span><span class="n">pyParz</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">mods</span><span class="p">,</span><span class="n">_fit_data</span><span class="p">,</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fits</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bestChisq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">res</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>
                    <span class="n">mod</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">chisq</span> <span class="o">&lt;</span><span class="n">bestChisq</span><span class="p">:</span>
                        <span class="n">bestChisq</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">chisq</span>
                        <span class="n">bestFit</span><span class="o">=</span><span class="n">mod</span>
                        <span class="n">bestRes</span><span class="o">=</span><span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bestFit</span><span class="o">=</span><span class="n">fits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
            <span class="n">bestRes</span><span class="o">=</span><span class="n">fits</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>


        <span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">fits</span><span class="p">,</span><span class="n">bestFit</span><span class="p">,</span><span class="n">bestRes</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">fitDict</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">fitDict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All models did not match, finding best...&#39;</span><span class="p">)</span>
        <span class="n">bestChisq</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">bestMod</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">chisq</span><span class="o">=</span><span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">chisq</span>
            <span class="k">if</span> <span class="n">chisq</span><span class="o">&lt;</span><span class="n">bestChisq</span><span class="p">:</span>
                <span class="n">bestChisq</span><span class="o">=</span><span class="n">chisq</span>
                <span class="n">bestMod</span><span class="o">=</span><span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">name</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>

                <span class="k">if</span> <span class="n">f</span> <span class="ow">and</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">bestMod</span><span class="p">:</span>
                    <span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
                    <span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>
                    <span class="k">break</span>
    <span class="n">dofs</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">fitDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">_</span><span class="p">,</span><span class="n">bestFit</span><span class="p">,</span><span class="n">bestMod</span><span class="o">=</span><span class="n">fitDict</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="n">tempTable</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
            <span class="n">tempTable</span><span class="o">=</span><span class="n">tempTable</span><span class="p">[</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;flip&#39;</span><span class="p">]:</span>
            <span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;t0&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">],</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;t0_guess&#39;</span><span class="p">][</span><span class="n">d</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxFlux</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>
                <span class="n">maxTime</span><span class="o">=</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">maxFlux</span><span class="p">]</span>
                <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">maxTime</span><span class="p">,</span><span class="n">t0Bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">maxTime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;snType&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;Ia&#39;</span> <span class="ow">and</span> <span class="s1">&#39;x1&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;x1&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;guess_amp&#39;</span><span class="p">]:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">][</span><span class="s1">&#39;amplitude&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ampBounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]),</span><span class="n">ampBounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
            <span class="n">guess_amp_bounds</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess_amp_bounds</span><span class="o">=</span><span class="kc">False</span>
        <span class="n">nest_res</span><span class="p">,</span><span class="n">nest_fit</span><span class="o">=</span><span class="n">_nested_wrapper</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">tempTable</span><span class="p">,</span><span class="n">bestFit</span><span class="p">,</span><span class="n">vparams</span><span class="o">=</span><span class="n">bestRes</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">],</span>
                                          <span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="n">guess_amp_bounds</span><span class="p">,</span><span class="n">microlensing</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;microlensing&#39;</span><span class="p">],</span>
                                          <span class="n">zpsys</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">zpsys</span><span class="p">,</span><span class="n">kernel</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">],</span><span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">nsamples</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;nMicroSamples&#39;</span><span class="p">])</span>




        <span class="k">if</span> <span class="n">nest_res</span><span class="o">.</span><span class="n">ndof</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tempTable</span><span class="p">)</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest_res</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">):</span>
            <span class="n">dofs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tempTable</span><span class="p">)</span><span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">nest_res</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dofs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">nest_res</span><span class="o">.</span><span class="n">ndof</span>


        <span class="n">resList</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">nest_res</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nest_fit</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">nest_res</span>


    <span class="n">joint</span><span class="o">=</span><span class="n">_joint_likelihood</span><span class="p">(</span><span class="n">resList</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
        <span class="n">errs</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="k">if</span> <span class="s1">&#39;micro&#39;</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">errs</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errs</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span><span class="o">=</span><span class="mf">0.</span>
        <span class="n">tempTable</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
            <span class="n">tempTable</span><span class="o">=</span><span class="n">tempTable</span><span class="p">[</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">x</span> <span class="ow">in</span> <span class="n">__thetaL__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">joint</span><span class="o">.</span><span class="n">keys</span><span class="p">()]):</span><span class="c1"># or args[&#39;microlensing&#39;] is not None:</span>
            <span class="n">bds</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>

            <span class="n">final_vparams</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">==</span><span class="s1">&#39;t0&#39;</span><span class="p">:</span>
                            <span class="n">bds</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="o">+</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">p</span><span class="o">!=</span><span class="s1">&#39;amplitude&#39;</span> <span class="ow">and</span> <span class="n">p</span><span class="o">!=</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">bds</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-.</span><span class="mi">05</span><span class="o">*</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+.</span><span class="mi">05</span><span class="o">*</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">bds</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">errs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">final_vparams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>



                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
                        <span class="n">errs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">finalRes</span><span class="p">,</span><span class="n">finalFit</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">tempTable</span><span class="p">,</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">final_vparams</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="n">guess_amp_bounds</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">finalRes</span><span class="o">.</span><span class="n">ndof</span><span class="o">=</span><span class="n">dofs</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
            <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">finalFit</span>
            <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">finalRes</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">joint</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="o">.</span><span class="n">param_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="nb">dict</span><span class="p">):</span>
                        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
                        <span class="n">errs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
                        <span class="n">errs</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">joint</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;final_errs&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">errs</span>

    <span class="n">tds</span><span class="p">,</span><span class="n">td_errs</span><span class="p">,</span><span class="n">mags</span><span class="p">,</span><span class="n">mag_errs</span><span class="p">,</span><span class="n">times</span><span class="p">,</span><span class="n">fluxes</span><span class="p">,</span><span class="n">time_errors</span><span class="p">,</span><span class="n">flux_errors</span><span class="o">=</span><span class="n">timeDelaysAndMagnifications</span><span class="p">(</span><span class="n">curves</span><span class="p">)</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">time_delays</span><span class="o">=</span><span class="n">tds</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">time_delay_errors</span><span class="o">=</span><span class="n">td_errs</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">magnifications</span><span class="o">=</span><span class="n">mags</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">magnification_errors</span><span class="o">=</span><span class="n">mag_errs</span>
    <span class="n">curves</span><span class="o">.</span><span class="n">measurements</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;t0&#39;</span><span class="p">:</span><span class="n">times</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">:</span><span class="n">fluxes</span><span class="p">,</span><span class="s1">&#39;t0_err&#39;</span><span class="p">:</span><span class="n">time_errors</span><span class="p">,</span><span class="s1">&#39;A_err&#39;</span><span class="p">:</span><span class="n">flux_errors</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;showPlots&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">tempTable</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bands&#39;</span><span class="p">]]:</span>
                <span class="n">tempTable</span><span class="o">=</span><span class="n">tempTable</span><span class="p">[</span><span class="n">tempTable</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">b</span><span class="p">]</span>
            <span class="n">tempMod</span><span class="o">=</span><span class="n">copy</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>


            <span class="n">sncosmo</span><span class="o">.</span><span class="n">plot_lc</span><span class="p">(</span><span class="n">tempTable</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="n">tempMod</span><span class="p">)</span>

            <span class="c1">#plt.savefig(nest_fit._source.name+&#39;_&#39;+tempTable[&#39;band&#39;][0]+&#39;_refs_&#39;+d+&#39;.pdf&#39;,format=&#39;pdf&#39;,overwrik4ite=True)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">curves</span>

<span class="k">def</span> <span class="nf">_micro_uncertainty</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">sample</span><span class="p">,</span><span class="n">other</span><span class="o">=</span><span class="n">args</span>
    <span class="n">nest_fit</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">colnames</span><span class="p">,</span><span class="n">x_pred</span><span class="p">,</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">other</span>
    <span class="n">data</span><span class="o">=</span><span class="n">Table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">colnames</span><span class="p">)</span>

    <span class="n">temp_nest_mod</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">nest_fit</span><span class="p">)</span>
    <span class="n">tempMicro</span><span class="o">=</span><span class="n">AchromaticMicrolensing</span><span class="p">(</span><span class="n">x_pred</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nest_fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)),</span><span class="n">sample</span><span class="p">,</span><span class="n">magformat</span><span class="o">=</span><span class="s1">&#39;multiply&#39;</span><span class="p">)</span>
    <span class="n">temp_nest_mod</span><span class="o">.</span><span class="n">add_effect</span><span class="p">(</span><span class="n">tempMicro</span><span class="p">,</span><span class="s1">&#39;microlensing&#39;</span><span class="p">,</span><span class="s1">&#39;rest&#39;</span><span class="p">)</span>
    <span class="n">tempRes</span><span class="p">,</span><span class="n">tempMod</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">temp_nest_mod</span><span class="p">,</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">tempMod</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_nested_wrapper</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">vparams</span><span class="p">,</span><span class="n">bounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="p">,</span><span class="n">microlensing</span><span class="p">,</span><span class="n">zpsys</span><span class="p">,</span><span class="n">kernel</span><span class="p">,</span><span class="n">maxiter</span><span class="p">,</span><span class="n">npoints</span><span class="p">,</span><span class="n">nsamples</span><span class="p">):</span>

    <span class="n">temp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">vparam_names</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">vparams</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">microlensing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nest_res</span><span class="p">,</span><span class="n">nest_fit</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="n">guess_amplitude_bound</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">)</span>




        <span class="n">micro</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">x_pred</span><span class="p">,</span><span class="n">y_pred</span><span class="p">,</span><span class="n">samples</span><span class="o">=</span><span class="n">fit_micro</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">nest_res</span><span class="p">,</span><span class="n">nest_fit</span><span class="p">,</span><span class="n">temp</span><span class="p">,</span><span class="n">zpsys</span><span class="p">,</span><span class="n">nsamples</span><span class="p">,</span><span class="n">micro_type</span><span class="o">=</span><span class="n">microlensing</span><span class="p">,</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">)</span>


        <span class="n">temp</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">t0s</span><span class="o">=</span><span class="n">pyParz</span><span class="o">.</span><span class="n">foreach</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">_micro_uncertainty</span><span class="p">,[</span><span class="n">nest_fit</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span><span class="n">temp</span><span class="o">.</span><span class="n">colnames</span><span class="p">,</span><span class="n">x_pred</span><span class="p">,</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="p">])</span>
        <span class="n">mu</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">t0s</span><span class="p">)</span>

        <span class="n">nest_res</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s1">&#39;micro&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nest_fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">)</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bestRes</span><span class="o">=</span><span class="n">nest_res</span>
        <span class="n">bestMod</span><span class="o">=</span><span class="n">nest_fit</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">bestRes</span><span class="p">,</span><span class="n">bestMod</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">model</span><span class="p">,</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">vparam_names</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="n">guess_amplitude_bound</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="n">npoints</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">bestRes</span><span class="p">,</span><span class="n">bestMod</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_maxFromModel</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="n">band</span><span class="p">,</span><span class="n">zp</span><span class="p">,</span><span class="n">zpsys</span><span class="p">):</span>
    <span class="n">time</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">mintime</span><span class="p">(),</span><span class="n">mod</span><span class="o">.</span><span class="n">maxtime</span><span class="p">(),</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">flux</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">bandflux</span><span class="p">(</span><span class="n">band</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">zp</span><span class="p">,</span><span class="n">zpsys</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">flux</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">)],</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">flux</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">fit_micro</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">fit</span><span class="p">,</span><span class="n">dat</span><span class="p">,</span><span class="n">zpsys</span><span class="p">,</span><span class="n">nsamples</span><span class="p">,</span><span class="n">micro_type</span><span class="o">=</span><span class="s1">&#39;achromatic&#39;</span><span class="p">,</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;RBF&#39;</span><span class="p">):</span>
    <span class="n">t0</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">)</span>
    <span class="n">fit</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">t0</span><span class="o">=</span><span class="n">t0</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>

    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">-=</span><span class="n">t0</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="mf">40.</span><span class="p">]</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">&gt;=-</span><span class="mf">15.</span><span class="p">]</span>
    <span class="n">achromatic</span><span class="o">=</span><span class="n">micro_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;achromatic&#39;</span>
    <span class="k">if</span> <span class="n">achromatic</span><span class="p">:</span>
        <span class="n">allResid</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">allErr</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">allTime</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allResid</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="n">allErr</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
        <span class="n">allTime</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]):</span>
        <span class="n">tempData</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">]</span>
        <span class="n">tempData</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">&gt;.</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tempTime</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">mod</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">bandflux</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">tempTime</span><span class="o">+</span><span class="n">t0</span><span class="p">,</span><span class="n">zpsys</span><span class="o">=</span><span class="n">zpsys</span><span class="p">,</span><span class="n">zp</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;zp&#39;</span><span class="p">])</span>
        <span class="c1">#fig=plt.figure()</span>
        <span class="c1">#ax=fig.gca()</span>
        <span class="c1">#ax.plot(tempTime,mod)</span>
        <span class="c1">#ax.scatter(tempData[&#39;time&#39;],tempData[&#39;flux&#39;])</span>
        <span class="c1">#plt.show()</span>
        <span class="n">tempData</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="n">mod</span><span class="o">&gt;.</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">residual</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">mod</span><span class="p">[</span><span class="n">mod</span><span class="o">&gt;.</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tempData</span><span class="o">=</span><span class="n">tempData</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residual</span><span class="p">)]</span>
        <span class="n">residual</span><span class="o">=</span><span class="n">residual</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residual</span><span class="p">)]</span>
        <span class="n">tempTime</span><span class="o">=</span><span class="n">tempTime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">residual</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">achromatic</span><span class="p">:</span>
            <span class="n">allResid</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allResid</span><span class="p">,</span><span class="n">residual</span><span class="p">)</span>
            <span class="n">allErr</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allErr</span><span class="p">,</span><span class="n">residual</span><span class="o">*</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;fluxerr&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span>
            <span class="n">allTime</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allTime</span><span class="p">,</span><span class="n">tempTime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">allResid</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">residual</span>
            <span class="n">allErr</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">residual</span><span class="o">*</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;fluxerr&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">tempData</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="n">allTime</span><span class="p">[</span><span class="n">b</span><span class="p">]</span><span class="o">=</span><span class="n">tempTime</span>

    <span class="k">if</span> <span class="n">kernel</span><span class="o">==</span><span class="s1">&#39;RBF&#39;</span><span class="p">:</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">RBF</span><span class="p">(</span><span class="mf">10.</span><span class="p">,</span> <span class="p">(</span><span class="mf">20.</span><span class="p">,</span> <span class="mf">50.</span><span class="p">))</span>


    <span class="k">if</span> <span class="n">achromatic</span><span class="p">:</span>

        <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">allErr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span>
                                      <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">allTime</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">allResid</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">allTime</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">temp2</span><span class="o">=</span><span class="n">allResid</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp2</span><span class="p">)]</span>
            <span class="n">temp2</span><span class="o">=</span><span class="n">temp2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">temp2</span><span class="p">)]</span>
            <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">temp2</span><span class="p">)</span>



        <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allTime</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allTime</span><span class="p">),</span> <span class="mi">1000</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

        <span class="n">y_pred</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">samples</span><span class="o">=</span><span class="n">gp</span><span class="o">.</span><span class="n">sample_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nsamples</span><span class="p">)</span>


        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        plt.close()</span>
<span class="sd">        fig=plt.figure()</span>
<span class="sd">        ax=fig.gca()</span>
<span class="sd">        for i in range(samples.shape[1]):</span>
<span class="sd">            if i==0:</span>
<span class="sd">                ax.plot(X, samples[:,i],alpha=.1,label=&#39;Posterior Samples&#39;,color=&#39;b&#39;)</span>
<span class="sd">            else:</span>
<span class="sd">                ax.plot(X, samples[:,i],alpha=.1,color=&#39;b&#39;)</span>
<span class="sd">        ax.errorbar(allTime.ravel(), allResid, allErr, fmt=&#39;r.&#39;, markersize=10, label=u&#39;Observations&#39;)</span>
<span class="sd">        print(len(allResid))</span>
<span class="sd">        ax.plot(X, y_pred - 3 * sigma, &#39;--g&#39;)</span>
<span class="sd">        ax.plot(X, y_pred + 3 * sigma, &#39;--g&#39;,label=&#39;$3\sigma$ Bounds&#39;)</span>
<span class="sd">        ax.plot(X,y_pred,&#39;k-.&#39;,label=&quot;GPR Prediction&quot;)</span>

<span class="sd">        ax.set_ylabel(&#39;Magnification ($\mu$)&#39;)</span>
<span class="sd">        ax.set_xlabel(&#39;Observer Frame Time (Days)&#39;)</span>
<span class="sd">        ax.plot(X,curves.images[&#39;S2&#39;].simMeta[&#39;microlensing_params&#39;](X/(1+1.33))/np.median(curves.images[&#39;S2&#39;].simMeta[&#39;microlensing_params&#39;](X/(1+1.33))),&#39;k&#39;,label=&#39;True $\mu$-Lensing&#39;)</span>
<span class="sd">        ax.legend(fontsize=10)</span>
<span class="sd">        plt.savefig(&#39;microlensing_gpr.pdf&#39;,format=&#39;pdf&#39;,overwrite=True)</span>
<span class="sd">        plt.close()</span>
<span class="sd">        sys.exit()</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tempX</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tempX</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">fit</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">_phase</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))],</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempX</span><span class="p">,[</span><span class="n">fit</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">_phase</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">))]))</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">1.</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,[</span><span class="mf">1.</span><span class="p">]))</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigma</span><span class="p">,[</span><span class="mf">0.</span><span class="p">]))</span>

        <span class="n">result</span><span class="o">=</span><span class="n">AchromaticMicrolensing</span><span class="p">(</span><span class="n">tempX</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">fit</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)),</span><span class="n">y_pred</span><span class="p">,</span><span class="n">magformat</span><span class="o">=</span><span class="s1">&#39;multiply&#39;</span><span class="p">)</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        fig=plt.figure()</span>
<span class="sd">        ax=fig.gca()</span>
<span class="sd">        #plt.plot(X, resid, &#39;r:&#39;, label=u&#39;$f(x) = x\,\sin(x)$&#39;)</span>
<span class="sd">        ax.errorbar(allTime.ravel(), allResid, allErr, fmt=&#39;r.&#39;, markersize=10, label=u&#39;Observations&#39;)</span>
<span class="sd">        #for c in np.arange(0,1.01,.1):</span>
<span class="sd">        #    for d in np.arange(-np.max(sigma),np.max(sigma),np.max(sigma)/10):</span>
<span class="sd">        #        plt.plot(X, 1+(y_pred[1:-1]-1)*c+d, &#39;b-&#39;)#, label=u&#39;Prediction&#39;)</span>
<span class="sd">        ax.plot(X, y_pred[1:-1], &#39;b-&#39; ,label=u&#39;Prediction&#39;)</span>

<span class="sd">        ax.fill(np.concatenate([X, X[::-1]]),</span>
<span class="sd">                 np.concatenate([y_pred[1:-1] - 1.9600 * sigma[1:-1],</span>
<span class="sd">                                 (y_pred[1:-1] + 1.9600 * sigma[1:-1])[::-1]]),</span>
<span class="sd">                 alpha=.5, fc=&#39;b&#39;, ec=&#39;None&#39;, label=&#39;95% confidence interval&#39;)</span>
<span class="sd">        ax.set_xlabel(&#39;$x$&#39;)</span>
<span class="sd">        ax.set_ylabel(&#39;$f(x)$&#39;)</span>
<span class="sd">        #plt.xlim(-10, 50)</span>
<span class="sd">        #plt.ylim(.8, 1.4)</span>

<span class="sd">        ax.legend(loc=&#39;upper left&#39;)</span>
<span class="sd">        #plt.show()</span>
<span class="sd">        #plt.show()</span>
<span class="sd">        #figures.append(ax)</span>
<span class="sd">        #plt.clf()</span>
<span class="sd">        plt.close()</span>
<span class="sd">        &#39;&#39;&#39;</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#TODO make chromatic microlensing a thing</span>



    <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">y_pred</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">samples</span>

<span class="k">def</span> <span class="nf">timeDelaysAndMagnifications</span><span class="p">(</span><span class="n">curves</span><span class="p">):</span>
    <span class="n">times</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">fluxes</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">time_errors</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">flux_errors</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

        <span class="n">b</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">curves</span><span class="o">.</span><span class="n">bands</span> <span class="k">if</span> <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bandoverlap</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;None of your bands overlap your fit?&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
        <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeOfPeak</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;t0&#39;</span><span class="p">)</span>
            <span class="n">band_time_errors</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">final_errs</span><span class="p">[</span><span class="s1">&#39;t0&#39;</span><span class="p">]</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">timeOfPeak</span><span class="p">,</span><span class="n">peakFlux</span><span class="o">=</span><span class="n">_maxFromModel</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">b</span><span class="p">,</span>
                                              <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;zp&#39;</span><span class="p">][</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">],</span>
                                              <span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">zpsys</span><span class="p">)</span>
            <span class="n">band_time_errors</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">band_flux_errors</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">for</span> <span class="n">amp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">peakFlux</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
                <span class="n">band_flux_errors</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">final_errs</span><span class="p">[</span><span class="n">amp</span><span class="p">]</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">success</span><span class="o">=</span><span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">peakFlux</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">bandflux</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">timeOfPeak</span><span class="p">,</span>
                                                          <span class="n">zp</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;zp&#39;</span><span class="p">][</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="s1">&#39;band&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">b</span><span class="p">],</span>
                                                          <span class="n">zpsys</span><span class="o">=</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">zpsys</span><span class="p">)</span>
            <span class="n">band_flux_errors</span><span class="o">=</span><span class="mi">0</span>


        <span class="n">band_times</span><span class="o">=</span><span class="n">timeOfPeak</span>
        <span class="n">band_fluxes</span><span class="o">=</span><span class="n">peakFlux</span>
        <span class="n">times</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">band_times</span>
        <span class="n">fluxes</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">band_fluxes</span>
        <span class="n">time_errors</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">band_time_errors</span>
        <span class="n">flux_errors</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">=</span><span class="n">band_flux_errors</span>
    <span class="n">ims</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">curves</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">delays</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">mags</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">delay_errs</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">mag_errs</span><span class="o">=</span><span class="nb">dict</span><span class="p">([])</span>
    <span class="n">ref1</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">ref2</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">ref1_err</span><span class="o">=</span><span class="kc">None</span>
    <span class="n">ref2_err</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">ims</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ref1</span><span class="p">:</span>
            <span class="n">ref1</span><span class="o">=</span><span class="n">times</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">delays</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">ref2</span><span class="o">=</span><span class="n">fluxes</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">mags</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">ref1_err</span><span class="o">=</span><span class="n">time_errors</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">ref2_err</span><span class="o">=</span><span class="n">flux_errors</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">delay_errs</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">mag_errs</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">delays</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">ref1</span><span class="o">-</span><span class="n">times</span><span class="p">[</span><span class="n">im</span><span class="p">]</span>
            <span class="n">mags</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">fluxes</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">/</span><span class="n">ref2</span>
            <span class="n">delay_errs</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">time_errors</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">ref1_err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">mag_errs</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">=</span><span class="n">mags</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">flux_errors</span><span class="p">[</span><span class="n">im</span><span class="p">]</span><span class="o">/</span><span class="n">fluxes</span><span class="p">[</span><span class="n">im</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">ref2_err</span><span class="o">/</span><span class="n">ref2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">delays</span><span class="p">,</span><span class="n">delay_errs</span><span class="p">,</span><span class="n">mags</span><span class="p">,</span><span class="n">mag_errs</span><span class="p">,</span><span class="n">times</span><span class="p">,</span><span class="n">fluxes</span><span class="p">,</span><span class="n">time_errors</span><span class="p">,</span><span class="n">flux_errors</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">_plot_marginal_pdfs</span><span class="p">(</span> <span class="n">res</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; plot the results of a classification run</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">pl</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

    <span class="n">nparam</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">)</span>
    <span class="c1"># nrow = np.sqrt( nparam )</span>
    <span class="c1"># ncol = nparam / nrow + 1</span>
    <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nparam</span>

    <span class="n">pdfdict</span> <span class="o">=</span> <span class="n">_get_marginal_pdfs</span><span class="p">(</span> <span class="n">res</span><span class="p">,</span> <span class="n">nbins</span> <span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">parname</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span> <span class="p">:</span>
        <span class="n">iax</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">parname</span> <span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">iax</span> <span class="p">)</span>

        <span class="n">parval</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">pdfdict</span><span class="p">[</span><span class="n">parname</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>  <span class="n">parval</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  </span><span class="si">%.1f</span><span class="s1"> +- </span><span class="si">%.1f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">parname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">1</span><span class="p">)),</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.01</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> +- </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">parname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.001</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  </span><span class="si">%.3f</span><span class="s1"> +- </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">parname</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">  </span><span class="si">%.3e</span><span class="s1"> +- </span><span class="si">%.3e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">parname</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">),</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span> <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_fit_data_wrap</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_fit_data</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There was an issue running model </span><span class="si">{0}</span><span class="s1">, skipping...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span> <span class="kc">None</span><span class="c1">#args[0]</span>

<span class="c1">#todo decide about multiple versions of model</span>
<span class="k">def</span> <span class="nf">_fit_data</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function that allows parallel processing to occur.</span>
<span class="sd">    :param args: All the arguments given from fit_data</span>
<span class="sd">    :return: modResults: tuple (Name of current model (including version if exists),name of the sncosmo model,version</span>
<span class="sd">                    of sncosmo model,list of tuples containing index and dcurve.fit[modname] for each dcurve in curves)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">mod</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dust_dict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;SFD98Map&#39;</span><span class="p">:</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">SFD98Map</span><span class="p">,</span><span class="s1">&#39;CCM89Dust&#39;</span><span class="p">:</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">CCM89Dust</span><span class="p">,</span><span class="s1">&#39;OD94Dust&#39;</span><span class="p">:</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">OD94Dust</span><span class="p">,</span><span class="s1">&#39;F99Dust&#39;</span><span class="p">:</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">F99Dust</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;dust&#39;</span><span class="p">]:</span>
        <span class="n">dust</span><span class="o">=</span><span class="n">dust_dict</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;dust&#39;</span><span class="p">]]()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dust</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">effect_names</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;effect_names&#39;</span><span class="p">]</span>
    <span class="n">effect_frames</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;effect_frames&#39;</span><span class="p">]</span>
    <span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">dust</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">effect_names</span><span class="p">))]</span> <span class="k">if</span> <span class="n">effect_names</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">effect_names</span><span class="o">=</span><span class="n">effect_names</span> <span class="k">if</span> <span class="n">effect_names</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">effect_frames</span><span class="o">=</span><span class="n">effect_frames</span> <span class="k">if</span> <span class="n">effect_frames</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effect_names</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">effect_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">effect_frames</span><span class="p">,(</span><span class="nb">list</span><span class="p">,</span><span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">effects</span><span class="o">=</span><span class="p">[</span><span class="n">effect_frames</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
        <span class="n">modName</span><span class="o">=</span><span class="n">mod</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">version</span> <span class="k">if</span> <span class="n">version</span> <span class="k">else</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">modName</span><span class="o">=</span><span class="n">mod</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">version</span> <span class="k">if</span> <span class="n">version</span> <span class="k">else</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="n">source</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">get_source</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="c1">#print(mod)</span>
    <span class="n">smod</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span><span class="n">effects</span><span class="o">=</span><span class="n">effects</span><span class="p">,</span><span class="n">effect_names</span><span class="o">=</span><span class="n">effect_names</span><span class="p">,</span><span class="n">effect_frames</span><span class="o">=</span><span class="n">effect_frames</span><span class="p">)</span>
    <span class="n">params</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">smod</span><span class="o">.</span><span class="n">param_names</span><span class="p">]</span>
    <span class="n">fits</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
    <span class="n">dcurve</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">smod</span><span class="o">.</span><span class="n">bandoverlap</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">dcurve</span><span class="o">.</span><span class="n">bands</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;yep&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No band overlap for model </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">modName</span><span class="p">)</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">method</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">bounds</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">ignore</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;ignore&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dcurve</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span><span class="n">dcurve</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;info&#39;</span><span class="p">}</span>


    <span class="n">no_bound</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_needs_bounds</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">if</span> <span class="n">no_bound</span><span class="p">:</span>
        <span class="n">params</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">-</span><span class="n">no_bound</span><span class="p">)</span>
    <span class="n">params</span><span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">ignore</span> <span class="ow">and</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
    <span class="n">fits</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
    <span class="k">if</span> <span class="n">fits</span><span class="o">.</span><span class="n">constants</span><span class="p">:</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="n">fits</span><span class="o">.</span><span class="n">constants</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">smod</span><span class="o">.</span><span class="n">param_names</span><span class="p">}</span>
        <span class="n">smod</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">constants</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;doFit&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mcmc&#39;</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sn_func&#39;</span><span class="p">][</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]](</span><span class="n">dcurve</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">smod</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;nest&#39;</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sn_func&#39;</span><span class="p">][</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]](</span><span class="n">dcurve</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">smod</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;sn_func&#39;</span><span class="p">][</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;fitting_method&#39;</span><span class="p">]](</span><span class="n">dcurve</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">smod</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">fits</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;props&#39;</span><span class="p">])</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pyParz</span><span class="o">.</span><span class="n">parReturn</span><span class="p">(</span><span class="n">fits</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">model</span><span class="o">=</span><span class="n">smod</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="o">=</span><span class="n">newDict</span><span class="p">()</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;vparam_names&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">fits</span><span class="o">.</span><span class="n">params</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">fits</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_joint_likelihood</span><span class="p">(</span><span class="n">resList</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>


    <span class="n">params</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">resList</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">params</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">)))</span>
    <span class="n">otherParams</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__thetaL__</span><span class="p">]</span>
    <span class="n">snparams</span><span class="o">=</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">__thetaSN__</span><span class="p">]</span>
    <span class="n">outDict</span><span class="o">=</span><span class="p">{</span><span class="n">p</span><span class="p">:</span><span class="nb">dict</span><span class="p">([])</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">otherParams</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="n">probsList</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">weightsList</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">zweights</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">testList</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">resList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">vparam_names</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">res</span><span class="o">=</span><span class="n">resList</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">pdf</span><span class="o">=</span><span class="n">_get_marginal_pdfs</span><span class="p">(</span><span class="n">res</span><span class="p">,</span><span class="n">nbins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">snparams</span><span class="p">:</span>
                <span class="n">weightsList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weightsList</span><span class="p">,</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">4</span><span class="p">])))</span>
                <span class="n">testList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testList</span><span class="p">,</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">zweights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zweights</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">4</span><span class="p">]))</span>
                <span class="n">probsList</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">probsList</span><span class="p">,</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">otherParams</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Image </span><span class="si">%s</span><span class="s1">:  &lt;</span><span class="si">%s</span><span class="s1">&gt; = </span><span class="si">%.6e</span><span class="s1"> +- </span><span class="si">%.2e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span>
                <span class="n">outDict</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">pdf</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">otherParams</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">expectedValue</span><span class="o">=</span><span class="p">((</span><span class="n">weightsList</span><span class="o">*</span><span class="n">probsList</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">zweights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">((</span><span class="n">weightsList</span> <span class="o">*</span> <span class="p">(</span><span class="n">probsList</span><span class="o">-</span><span class="n">expectedValue</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">zweights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; = </span><span class="si">%.3e</span><span class="s1"> +- </span><span class="si">%.3e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">param</span><span class="p">,</span> <span class="n">expectedValue</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">outDict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">expectedValue</span><span class="p">,</span><span class="n">std</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">outDict</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_marginal_pdfs</span><span class="p">(</span> <span class="n">res</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">51</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Given the results &lt;res&gt; from a nested sampling chain, determine the</span>
<span class="sd">    marginalized posterior probability density functions for each of the</span>
<span class="sd">    parameters in the model.</span>
<span class="sd">    :param res:  the results of a nestlc run</span>
<span class="sd">    :param nbins: number of bins (steps along the x axis) for sampling</span>
<span class="sd">       each parameter&#39;s marginalized posterior probability</span>
<span class="sd">    :return: a dict with an entry for each parameter, giving a 2-tuple containing</span>
<span class="sd">       NDarrays of length nbins.  The first array in each pair gives the parameter</span>
<span class="sd">       value that defines the left edge of each bin along the parameter axis.</span>
<span class="sd">       The second array gives the posterior probability density integrated</span>
<span class="sd">       across that bin.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vparam_names</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">weights</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">samples</span>

    <span class="n">pdfdict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">vparam_names</span> <span class="p">:</span>
        <span class="n">ipar</span> <span class="o">=</span> <span class="n">vparam_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span> <span class="n">param</span> <span class="p">)</span>
        <span class="n">paramvals</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">ipar</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">nbins</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">bounds</span> <span class="p">:</span>
                <span class="n">parvalmin</span><span class="p">,</span> <span class="n">parvalmax</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">parvalmin</span><span class="p">,</span> <span class="n">parvalmax</span> <span class="o">=</span> <span class="mf">0.99</span><span class="o">*</span><span class="n">paramvals</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="mf">1.01</span><span class="o">*</span><span class="n">paramvals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">parambins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">parvalmin</span><span class="p">,</span> <span class="n">parvalmax</span><span class="p">,</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">binindices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span> <span class="n">paramvals</span><span class="p">,</span> <span class="n">parambins</span> <span class="p">)</span>

            <span class="c1"># we estimate the marginalized pdf by summing the weights of all points in the bin,</span>
            <span class="c1"># where the weight of each point is the prior volume at that point times the</span>
            <span class="c1"># likelihood, divided by the total evidence</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">weights</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">binindices</span><span class="o">==</span><span class="n">ibin</span> <span class="p">)]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">ibin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parambins</span><span class="p">))</span> <span class="p">]</span> <span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">parambins</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="kc">None</span>


        <span class="n">mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights</span>  <span class="o">*</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">ipar</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1">#print(samples[:,ipar]-mean)</span>
        <span class="c1">#print(weights)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="n">ipar</span><span class="p">]</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="p">)</span>


        <span class="n">pdfdict</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">parambins</span><span class="p">,</span><span class="n">pdf</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span><span class="n">std</span><span class="p">,</span><span class="n">res</span><span class="o">.</span><span class="n">logz</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; =  </span><span class="si">%.2f</span><span class="s1"> +- </span><span class="si">%.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">param</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>  <span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.01</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; =  </span><span class="si">%.3f</span><span class="s1"> +- </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">param</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">std</span><span class="p">)</span><span class="o">&gt;=</span><span class="mf">0.001</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; =  </span><span class="si">%.4f</span><span class="s1"> +- </span><span class="si">%.4f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">param</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span> <span class="p">)</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; = </span><span class="si">%.3e</span><span class="s1"> +- </span><span class="si">%.3e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="n">param</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span> <span class="p">)</span>


        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s1">&#39;x0&#39;</span> <span class="p">:</span>
            <span class="n">salt2</span> <span class="o">=</span> <span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;salt2&#39;</span><span class="p">)</span>
            <span class="n">salt2</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">set_peakmag</span><span class="p">(</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;bessellb&#39;</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span> <span class="p">)</span>
            <span class="n">x0_AB0</span> <span class="o">=</span> <span class="n">salt2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x0&#39;</span><span class="p">)</span>
            <span class="n">mBmean</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>  <span class="n">mean</span> <span class="o">/</span> <span class="n">x0_AB0</span> <span class="p">)</span>
            <span class="n">mBstd</span> <span class="o">=</span> <span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">e</span> <span class="p">)</span> <span class="o">*</span>  <span class="n">std</span> <span class="o">/</span> <span class="n">mean</span>
            <span class="n">mBbins</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>  <span class="n">parambins</span> <span class="o">/</span> <span class="n">x0_AB0</span> <span class="p">)</span>

            <span class="n">pdfdict</span><span class="p">[</span><span class="s1">&#39;mB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">mBbins</span><span class="p">,</span> <span class="n">pdf</span><span class="p">,</span> <span class="n">mBmean</span><span class="p">,</span> <span class="n">mBstd</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;  &lt;</span><span class="si">%s</span><span class="s1">&gt; =  </span><span class="si">%.3f</span><span class="s1"> +- </span><span class="si">%.3f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span> <span class="s1">&#39;mB&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mBmean</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">mBstd</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span>

    <span class="k">return</span><span class="p">(</span> <span class="n">pdfdict</span> <span class="p">)</span>


<span class="k">def</span> <span class="nf">param_fit</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="n">modName</span><span class="p">,</span><span class="n">fit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">sources</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;BazinSource&#39;</span><span class="p">:</span><span class="n">BazinSource</span><span class="p">}</span>

    <span class="n">source</span><span class="o">=</span><span class="n">sources</span><span class="p">[</span><span class="n">modName</span><span class="p">](</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="n">mod</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">]:</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;constants&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fit</span><span class="p">:</span>
        <span class="n">res</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Result</span><span class="p">()</span>
        <span class="n">res</span><span class="o">.</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#res,mod=sncosmo.fit_lc(args[&#39;curve&#39;].table,mod,args[&#39;params&#39;], bounds=args[&#39;bounds&#39;],guess_amplitude=True,guess_t0=True,maxcall=1)</span>

        <span class="k">if</span> <span class="s1">&#39;amplitude&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">]:</span>
            <span class="n">guess_amp_bound</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">guess_amp_bound</span><span class="o">=</span><span class="kc">True</span>




        <span class="n">res</span><span class="p">,</span><span class="n">mod</span><span class="o">=</span><span class="n">sncosmo</span><span class="o">.</span><span class="n">nest_lc</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;curve&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">,</span><span class="n">mod</span><span class="p">,</span><span class="n">vparam_names</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">],</span><span class="n">bounds</span><span class="o">=</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;bounds&#39;</span><span class="p">],</span><span class="n">guess_amplitude_bound</span><span class="o">=</span><span class="n">guess_amp_bound</span><span class="p">,</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span><span class="n">npoints</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="k">return</span><span class="p">({</span><span class="s1">&#39;res&#39;</span><span class="p">:</span><span class="n">res</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">:</span><span class="n">mod</span><span class="p">})</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Justin Pierel

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>